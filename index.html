<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Atm Powerfull Pro</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 10px;
      background-color: #f4f7f6;
      margin: 0;
    }

    /* Sticky Header */
    .sticky-header {
      position: sticky;
      top: 0;
      background: #f4f7f6;
      z-index: 1000;
      padding-bottom: 10px;
      border-bottom: 2px solid #007bff;
    }

    .btn-update {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 3px 12px;
      font-size: 10px;
      font-weight: bold;
      border-radius: 4px;
    }

    .search-input {
      border: 2px solid #007bff;
      border-radius: 25px;
      height: 40px;
      text-align: center;
      font-weight: bold;
      width: 75%;
      margin: 0 auto;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #search-stats {
      font-size: 11px;
      color: #555;
      font-weight: bold;
      margin-top: 5px;
      height: 15px;
    }

    /* Table Style */
    .table-container {
      background: white;
      border-radius: 12px;
      margin-top: 10px;
      height: calc(100vh - 180px);
      overflow: auto;
      border: 1px solid #ddd;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #dtable th {
      color: #fff;
      font-size: 0.8em;
      border: 1px solid #000;
      text-align: center;
      position: sticky;
      top: 0;
      padding: 10px;
      z-index: 20;
    }

    /* CUSTOM POPUP 3D STYLE */
    #customOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #customPopup {
      background: white;
      width: 85%;
      max-width: 350px;
      padding: 25px;
      border-radius: 20px;
      text-align: center;
      transform: scale(0.8) translateY(20px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    #customOverlay.active {
      opacity: 1;
    }

    #customOverlay.active #customPopup {
      transform: scale(1) translateY(0);
    }

    .pop-icon {
      font-size: 40px;
      margin-bottom: 15px;
      display: block;
    }

    .pop-title {
      font-weight: 800;
      color: #333;
      margin-bottom: 10px;
    }

    .pop-btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .pop-btn {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-confirm {
      background: #007bff;
      color: white;
    }

    .btn-cancel {
      background: #eee;
      color: #555;
    }

    /* FLOATING MENU */
    .fab-wrapper {
      position: fixed;
      bottom: 80px;
      right: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      z-index: 9000;
    }

    .fab-main {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      border: none;
      font-size: 24px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .fab-sub {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: white;
      border: 1px solid #ddd;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .fab-wrapper.active .fab-sub {
      display: flex;
    }

    #installArea {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 8000;
      width: 80%;
    }
  </style>
</head>

<body>

  <div id="customOverlay">
    <div id="customPopup">
      <span id="popIcon" class="pop-icon">üîÑ</span>
      <div id="popTitle" class="pop-title">Konfirmasi</div>
      <div id="popText" class="pop-text">Mohon tunggu sebentar...</div>
      <div class="pop-btn-group">
        <button id="popCancel" class="pop-btn btn-cancel">Batal</button>
        <button id="popConfirm" class="pop-btn btn-confirm">Ya, Lanjut</button>
      </div>
    </div>
  </div>

  <div class="sticky-header text-center">
    <h6 class="text-primary font-weight-bold mt-1">Atm Powerfull</h6>
    <button class="btn btn-primary btn-update" onclick="askUpdate()">Update</button>
    <div id="stats-area" class="badge badge-primary p-2 mb-1">Data: 0</div>
    <div class="d-flex justify-content-center">
      <input type="text" id="mencari" class="form-control search-input" placeholder="Cari Data..." oninput="triggerSearch(this.value)">
    </div>
    <div id="search-stats"></div>
    <div id="status" class="status-msg text-muted" style="font-size: 10px; margin-top:5px;">Inisialisasi...</div>
  </div>

  <div class="table-container">
    <div id="hasil"></div>
  </div>

  <div class="fab-wrapper" id="fabMenu">
    <button class="fab-main" onclick="toggleFab()">‚ò∞</button>
    <button class="fab-sub" onclick="syncData()">üîÑ</button>
    <button class="fab-sub" onclick="alert('GPS Aktif')">üìç</button>
    <button class="fab-sub" onclick="alert('Kamera Aktif')">üì∏</button>
  </div>

  <div id="installArea">
    <button class="btn btn-dark btn-block shadow-lg" onclick="installPWA()" style="border-radius: 20px; font-weight: bold;">Instal Aplikasi</button>
  </div>

  <script>
    const GAS_URL = "ISI_DENGAN_URL_GAS_ANDA";
    const db = new Dexie("DriverLocalDB");
    db.version(1).stores({
      files: "id, content"
    });
    // Hubungkan ke Worker
    const worker = new Worker('worker.js');
    // --- FUNGSI UI & POPUP ---
    function toggleFab() {
      document.getElementById('fabMenu').classList.toggle('active');
    }

    function showPopup({
      icon,
      title,
      text,
      onConfirm,
      showCancel = true
    }) {
      const overlay = document.getElementById('customOverlay');
      document.getElementById('popIcon').innerText = icon;
      document.getElementById('popTitle').innerText = title;
      document.getElementById('popText').innerText = text;
      document.getElementById('popCancel').style.display = showCancel ? 'block' : 'none';
      overlay.style.display = 'flex';
      setTimeout(() => overlay.classList.add('active'), 10);
      document.getElementById('popConfirm').onclick = () => {
        closePopup();
        if (onConfirm) onConfirm();
      };
      document.getElementById('popCancel').onclick = closePopup;
    }

    function closePopup() {
      const overlay = document.getElementById('customOverlay');
      overlay.classList.remove('active');
      setTimeout(() => overlay.style.display = 'none', 300);
    }
    // --- PENCARIAN VIA WORKER ---
    let searchTimer;

    function triggerSearch(v) {
      if (v.length < 2) {
        document.getElementById('hasil').innerHTML = "";
        document.getElementById('search-stats').innerText = "";
        return;
      }
      // Debounce agar tidak terlalu sering kirim pesan ke worker saat mengetik cepat
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        worker.postMessage({
          type: "SEARCH",
          payload: v
        });
      }, 100);
    }
    worker.onmessage = (e) => {
      const {
        type,
        data
      } = e.data;
      if (type === "RESULTS") {
        const rawData = data[0] ? data[0].result.map(r => r.doc.rowArray) : [];
        rawData.sort((a, b) => parseDate(b[1]) - parseDate(a[1]));
        renderTable(rawData);
      }
    };

    function renderTable(arr) {
      const container = document.getElementById('hasil');
      const stats = document.getElementById('search-stats');
      if (arr.length === 0) {
        container.innerHTML = "<div class='p-4 text-center'>Data tidak ditemukan</div>";
        stats.innerText = "TIDAK ADA HASIL";
        return;
      }
      stats.innerText = `DITEMUKAN: ${arr.length} DATA`;
      const fragment = document.createDocumentFragment();
      const table = document.createElement('table');
      table.className = "table table-sm table-striped";
      table.id = "dtable";
      table.style.fontSize = "0.8em";
      table.style.whiteSpace = "nowrap";
      const headers = ["NO", "TGL", "DRIVERS", "NOPOL", "NOKA", "NOSIN", "TYPE UNIT", "TUJUAN", "UANG JALAN", "VENDOR", "ASAL UNIT", "WARNA", "CODE BOT", "STATUS", "KETERANGAN"];
      const bg = ["#747D0C", "#27e861", "#D2691E", "#10ebe7", "#FF69B4", "#fa0702", "#eefa02", "#10ebe7", "#00FF7F", "#02b0fa", "#fca4a4", "#FFA500", "#929596", "#79fa02", "#a302fa"];
      let theadHtml = "<thead><tr>";
      headers.forEach((h, i) => theadHtml += `<th style="background-color:${bg[i]}">${h}</th>`);
      theadHtml += "</tr></thead>";
      table.innerHTML = theadHtml;
      const tbody = document.createElement('tbody');
      // Limit 100 untuk anti-lag
      arr.slice(0, 100).forEach(r => {
        const tr = document.createElement('tr');
        tr.className = "font-weight-bold text-center";
        let rowHtml = "";
        r.forEach((c, i) => {
          let v = c || "";
          if (i === 8 && !isNaN(v) && v !== "") v = "Rp " + Number(v).toLocaleString('id-ID');
          rowHtml += `<td style="border:1px solid #000">${v}</td>`;
        });
        tr.innerHTML = rowHtml;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.innerHTML = "";
      container.appendChild(table);
    }
    // --- LOGIKA DATA & SYNC ---
    async function syncData() {
      const statusEl = document.getElementById('status');
      try {
        const local = await db.files.get("main_data");
        let currentData = local ? local.content : [];
        const res = await fetch(`${GAS_URL}?action=checkUpdate&t=${Date.now()}`);
        const server = await res.json();
        const localVer = localStorage.getItem('db_ver');
        if (String(server.version) !== String(localVer)) {
          statusEl.innerText = "‚è≥ Sinkronisasi data...";
          const dRes = await fetch(`${GAS_URL}?action=getSmartUpdate&t=${Date.now()}`);
          const updates = await dRes.json();
          const uIds = new Set(updates.map(u => u.id));
          const finalData = [...updates, ...currentData.filter(d => !uIds.has(d.id))];
          await db.files.put({
            id: "main_data",
            content: finalData
          });
          localStorage.setItem('db_ver', server.version);
          worker.postMessage({
            type: "CLEAR"
          });
          worker.postMessage({
            type: "ADD",
            payload: finalData
          });
          showPopup({
            icon: "‚úÖ",
            title: "Update Selesai",
            text: `${updates.length} data baru disinkronkan.`,
            showCancel: false,
            onConfirm: () => location.reload()
          });
        } else {
          statusEl.innerText = "‚úÖ Data Cloud Sinkron";
        }
      } catch (e) {
        statusEl.innerText = "‚ö†Ô∏è Mode Offline";
      }
    }

    function askUpdate() {
      showPopup({
        icon: "üöÄ",
        title: "Perbarui Data",
        text: "Seluruh cache akan dibersihkan dan data disusun ulang.",
        onConfirm: async () => {
          localStorage.clear();
          await db.files.clear();
          location.reload(true);
        }
      });
    }

    function parseDate(d) {
      if (!d) return new Date(0);
      const parts = d.split('/');
      return parts.length === 3 ? new Date(parts[2], parts[1] - 1, parts[0]) : new Date(0);
    }
    // --- INIT ---
    window.onload = async () => {
      const local = await db.files.get("main_data");
      if (local && local.content) {
        worker.postMessage({
          type: "ADD",
          payload: local.content
        });
        document.getElementById('stats-area').innerText = `Data: ${local.content.length}`;
      }
      syncData();
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    };
    // --- INSTALL PWA ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installArea').style.display = 'block';
    });
    async function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt = null;
      document.getElementById('installArea').style.display = 'none';
    }
  </script>
</body>

</html>
